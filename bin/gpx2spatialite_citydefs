#!/usr/bin/env python
#-*- coding:utf-8 -*-

# Copyright (C) 2013, 2014  Peter Vasil <mail@petervasil.net>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see [http://www.gnu.org/licenses/].


import os.path
import sys
import re
from optparse import OptionParser
import gpx2spatialite
from gpx2spatialite import spatialite


def parseargs():
    """
    Parse commandline arguments
    """
    usage = "usage: %prog /path/to/database.sqlite /path/to/input_output.sql"
    optparser = OptionParser(usage, version="%prog 0.1")
    optparser.add_option("-e",
                         "--export",
                         dest="export_citydefs",
                         default=False,
                         action="store_true",
                         help="Export citydefs")
    optparser.add_option("-i",
                         "--import",
                         dest="import_citydefs",
                         default=False,
                         action="store_true",
                         help="Import citydefs")

    (options, args) = optparser.parse_args()
    if len(args) != 2:
        error = "Specify a database path and an import/export sql file"
        optparser.error(error)
        sys.exit(2)
    dbpath = os.path.expanduser(args[0])
    in_out_file = args[1]
    is_export = options.export_citydefs
    is_import = options.import_citydefs
    if not is_export and not is_import:
        error = "Please select option -e or -i"
        optparser.error(error)
        sys.exit(2)

    return is_export, is_import, dbpath, in_out_file


def export_citydefs(cursor, out_file):
    """
    Export citydefs from database to a sql insert script.
    """
    sql = "SELECT citydef_uid, city, country, AsText(geom) "
    sql += "FROM citydefs ORDER BY country, city"
    cursor.execute(sql)

    out_file.write("BEGIN TRANSACTION;\n")
    for row in cursor.fetchall():
        line = "INSERT INTO citydefs ('city', 'country', 'geom') VALUES"
        line += "(\"%s\", \"%s\", "\
                "GeomFromText('%s', 4326));\n" % (row[1].encode('utf-8'),
                                                  row[2].encode('utf-8'),
                                                  row[3].encode('utf-8'))
        out_file.write(line)
    out_file.write("COMMIT;\n")


def import_citydefs(cursor, sql_file):
    """
    Import citydefs from a sql insert script.
    """
    sql_lines = sql_file.readlines()
    for line in sql_lines:
        if re.match("BEGIN TRANSACTION|COMMIT", line) is None:
            try:
                cursor.execute(line)
            except spatialite.IntegrityError:
                pass


def main():

    is_export, is_import, dbpath, filepath = parseargs()

    conn = gpx2spatialite.get_connection(dbpath)
    cursor = conn.cursor()

    if is_export:
        with open(filepath, "w",) as f:
            export_citydefs(cursor, f)
    elif is_import:
        with open(filepath, "r") as f:
            import_citydefs(cursor, f)
            conn.commit()

    conn.close()


if __name__ == '__main__':
    sys.exit(main())
